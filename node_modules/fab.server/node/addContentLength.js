///////////////////////////
// NODE$ADDCONTENTLENGTH //
///////////////////////////  
module.exports = function( write ) {
  return fab.queue( function( upstream ) {
    return write( function( write, head, body ) {
      var buffered = fab.queue()
        , length = 0;

      return upstream( fab.render( function read( body, head ) {
        buffered = buffered.apply( this, arguments );

        if ( !arguments.length ) return buffered(
          write( undefined, { headers: { "content-length": length } } )
        );
        
        if ( body ) length += body.length;

        return read;
      }, head, body ), head, body );
    })();
  });
}//END EXPORTS